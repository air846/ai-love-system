# 故障排除指南

## 问题1: 403 Forbidden 错误

### 症状
- 前端请求API时返回403错误
- 控制台显示：`Failed to load resource: the server responded with a status of 403 (Forbidden)`

### 可能原因和解决方案

#### 1. 后端服务未启动
**检查方法：**
```bash
# 检查8080端口是否被占用
netstat -an | findstr :8080
# 或者
lsof -i :8080
```

**解决方案：**
```bash
cd backend
mvn spring-boot:run -Dspring-boot.run.profiles=dev
```

#### 2. 端口冲突
**检查方法：**
- 查看后端启动日志，确认监听端口
- 检查application.yml中的server.port配置

**解决方案：**
- 修改backend/src/main/resources/application.yml中的端口
- 或者停止占用8080端口的其他服务

#### 3. CORS配置问题
**检查方法：**
- 查看浏览器开发者工具的Network标签
- 检查是否有CORS相关错误

**解决方案：**
- 确认CorsConfig.java中包含了正确的前端地址
- 检查SecurityConfig.java中的CORS配置

#### 4. 安全配置问题
**检查方法：**
- 查看后端日志中的Spring Security相关信息
- 确认请求路径是否在permitAll列表中

**解决方案：**
- 检查SecurityConfig.java中的路径配置
- 确保公开端点正确配置

### 快速测试步骤

1. **测试后端健康状态**
   ```bash
   curl http://localhost:8080/api/health
   ```

2. **使用API测试页面**
   - 访问：http://localhost:3000/debug/api-test
   - 依次测试各个API端点

3. **检查网络代理**
   - 确认Vite代理配置正确
   - 检查vite.config.ts中的proxy设置

## 问题2: 音频相关警告

### 症状
- 控制台显示AudioWorklet相关警告
- ScriptProcessorNode废弃警告

### 解决方案

这些是非关键性警告，不影响核心功能：

1. **AudioWorklet警告**
   - 现代浏览器会自动回退到兼容模式
   - 可以忽略这些警告

2. **ScriptProcessorNode废弃警告**
   - 这是浏览器的兼容性警告
   - 代码已经实现了现代API的回退机制

3. **如果要完全禁用音频功能**
   ```typescript
   // 在App.vue中注释掉音频相关代码
   // soundEffects.playBreeze(3000)
   ```

## 问题3: Chrome扩展错误

### 症状
- `Unchecked runtime.lastError: The message port closed before a response was received.`

### 解决方案
这是Chrome扩展的问题，与应用无关：
1. 禁用相关的Chrome扩展
2. 或者忽略这个错误（不影响应用功能）

## 问题4: 用户偏好设置500错误

### 症状
- 访问用户偏好设置时返回500错误
- 控制台显示：`GET http://localhost:3002/api/auth/preferences 500`

### 解决方案

1. **检查数据库连接**
   ```bash
   # 确保MySQL服务正在运行
   mysql -u root -p
   USE ai_love_system;
   SHOW TABLES;
   ```

2. **检查用户表结构**
   ```sql
   DESCRIBE users;
   -- 确保preferences字段存在
   ```

3. **检查后端日志**
   - 查看控制台输出的详细错误信息
   - 检查是否有JSON解析错误

4. **重置用户偏好设置**
   ```sql
   UPDATE users SET preferences = NULL WHERE id = YOUR_USER_ID;
   ```

## 调试技巧

### 1. 启用详细日志
在application.yml中设置：
```yaml
logging:
  level:
    com.ai.love: DEBUG
    org.springframework.security: DEBUG
```

### 2. 使用浏览器开发者工具
- Network标签：查看HTTP请求和响应
- Console标签：查看JavaScript错误
- Application标签：检查localStorage中的token

### 3. 使用Swagger UI
访问：http://localhost:8080/api/swagger-ui.html
- 直接测试API端点
- 查看API文档和参数

### 4. 检查数据库状态
```sql
-- 检查用户表
SELECT id, username, email, preferences FROM users;

-- 检查最近的登录记录
SELECT username, last_login_at, login_count FROM users ORDER BY last_login_at DESC;
```

## 常见启动顺序

1. **启动MySQL数据库**
2. **启动后端服务**
   ```bash
   cd backend
   mvn spring-boot:run
   ```
3. **启动前端服务**
   ```bash
   cd frontend
   npm run dev
   ```
4. **访问应用**
   - 前端：http://localhost:3000
   - API文档：http://localhost:8080/api/swagger-ui.html
   - API测试：http://localhost:3000/debug/api-test

## 联系支持

如果以上方法都无法解决问题，请提供：
1. 完整的错误日志
2. 浏览器开发者工具的截图
3. 后端启动日志
4. 系统环境信息（操作系统、Java版本、Node.js版本）
